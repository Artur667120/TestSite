// –ú–æ–≤–∏ —Ç–∞ –ø–µ—Ä–µ–∫–ª–∞–¥–∏
const translations = {
    uk: {
        title: "–ú–æ—ó –õ–∏—Å—Ç–∏",
        addLetter: "–î–æ–¥–∞—Ç–∏ –ª–∏—Å—Ç",
        searchPlaceholder: "–ü–æ—à—É–∫ –ª–∏—Å—Ç—ñ–≤...",
        allDates: "–£—Å—ñ –¥–∞—Ç–∏",
        today: "–°—å–æ–≥–æ–¥–Ω—ñ",
        thisWeek: "–¶—å–æ–≥–æ —Ç–∏–∂–Ω—è",
        thisMonth: "–¶—å–æ–≥–æ –º—ñ—Å—è—Ü—è",
        allTags: "–£—Å—ñ —Ç–µ–≥–∏",
        important: "–í–∞–∂–ª–∏–≤–µ",
        personal: "–û—Å–æ–±–∏—Å—Ç–µ",
        work: "–†–æ–±–æ—Ç–∞",
        reminder: "–ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è",
        clearFilters: "–û—á–∏—Å—Ç–∏—Ç–∏",
        deleteConfirm: "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è",
        deleteMessage: "–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏",
        letters: "–ª–∏—Å—Ç(–∏)",
        warning: "–¶—é –¥—ñ—é –Ω–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏!",
        cancel: "–°–∫–∞—Å—É–≤–∞—Ç–∏",
        delete: "–í–∏–¥–∞–ª–∏—Ç–∏",
        editLetter: "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ª–∏—Å—Ç",
        addLetterModal: "–î–æ–¥–∞—Ç–∏ –ª–∏—Å—Ç",
        titleLabel: "–ó–∞–≥–æ–ª–æ–≤–æ–∫",
        contentLabel: "–ó–º—ñ—Å—Ç",
        tagsLabel: "–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∫–æ–º—É)",
        tagsPlaceholder: "—Ä–æ–±–æ—Ç–∞, –≤–∞–∂–ª–∏–≤–µ, –æ—Å–æ–±–∏—Å—Ç–µ",
        save: "–ó–±–µ—Ä–µ–≥—Ç–∏",
        readMode: "–†–µ–∂–∏–º —á–∏—Ç–∞–Ω–Ω—è",
        theme: "–¢–µ–º–∞",
        lightTheme: "–°–≤—ñ—Ç–ª–∞",
        darkTheme: "–¢–µ–º–Ω–∞",
        blueTheme: "–°–∏–Ω—è",
        greenTheme: "–ó–µ–ª–µ–Ω–∞",
        exportPDF: "–ï–∫—Å–ø–æ—Ä—Ç PDF",
        exportTXT: "–ï–∫—Å–ø–æ—Ä—Ç TXT",
        expand: "–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏",
        collapse: "–ó–≥–æ—Ä–Ω—É—Ç–∏",
        noLetters: "–ù–µ–º–∞—î –ª–∏—Å—Ç—ñ–≤",
        addFirstLetter: "–î–æ–¥–∞–π—Ç–µ —Å–≤—ñ–π –ø–µ—Ä—à–∏–π –ª–∏—Å—Ç",
        deleteSelected: "–í–∏–¥–∞–ª–∏—Ç–∏ –≤–∏–±—Ä–∞–Ω—ñ",
        edit: "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏",
        view: "–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏",
        date: "–î–∞—Ç–∞",
        tags: "–¢–µ–≥–∏"
    },
    en: {
        title: "My Letters",
        addLetter: "Add Letter",
        searchPlaceholder: "Search letters...",
        allDates: "All dates",
        today: "Today",
        thisWeek: "This week",
        thisMonth: "This month",
        allTags: "All tags",
        important: "Important",
        personal: "Personal",
        work: "Work",
        reminder: "Reminder",
        clearFilters: "Clear",
        deleteConfirm: "Delete Confirmation",
        deleteMessage: "Are you sure you want to delete",
        letters: "letter(s)",
        warning: "This action cannot be undone!",
        cancel: "Cancel",
        delete: "Delete",
        editLetter: "Edit Letter",
        addLetterModal: "Add Letter",
        titleLabel: "Title",
        contentLabel: "Content",
        tagsLabel: "Tags (comma separated)",
        tagsPlaceholder: "work, important, personal",
        save: "Save",
        readMode: "Reading Mode",
        theme: "Theme",
        lightTheme: "Light",
        darkTheme: "Dark",
        blueTheme: "Blue",
        greenTheme: "Green",
        exportPDF: "Export PDF",
        exportTXT: "Export TXT",
        expand: "Expand",
        collapse: "Collapse",
        noLetters: "No letters",
        addFirstLetter: "Add your first letter",
        deleteSelected: "Delete Selected",
        edit: "Edit",
        view: "View",
        date: "Date",
        tags: "Tags"
    },
    de: {
        title: "Meine Briefe",
        addLetter: "Brief hinzuf√ºgen",
        searchPlaceholder: "Briefe suchen...",
        allDates: "Alle Daten",
        today: "Heute",
        thisWeek: "Diese Woche",
        thisMonth: "Diesen Monat",
        allTags: "Alle Tags",
        important: "Wichtig",
        personal: "Pers√∂nlich",
        work: "Arbeit",
        reminder: "Erinnerung",
        clearFilters: "L√∂schen",
        deleteConfirm: "L√∂schbest√§tigung",
        deleteMessage: "Sind Sie sicher, dass Sie l√∂schen m√∂chten",
        letters: "Brief(e)",
        warning: "Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!",
        cancel: "Abbrechen",
        delete: "L√∂schen",
        editLetter: "Brief bearbeiten",
        addLetterModal: "Brief hinzuf√ºgen",
        titleLabel: "Titel",
        contentLabel: "Inhalt",
        tagsLabel: "Tags (kommagetrennt)",
        tagsPlaceholder: "Arbeit, wichtig, pers√∂nlich",
        save: "Speichern",
        readMode: "Lesemodus",
        theme: "Thema",
        lightTheme: "Hell",
        darkTheme: "Dunkel",
        blueTheme: "Blau",
        greenTheme: "Gr√ºn",
        exportPDF: "PDF exportieren",
        exportTXT: "TXT exportieren",
        expand: "Erweitern",
        collapse: "Zusammenklappen",
        noLetters: "Keine Briefe",
        addFirstLetter: "F√ºgen Sie Ihren ersten Brief hinzu",
        deleteSelected: "Ausgew√§hlte l√∂schen",
        edit: "Bearbeiten",
        view: "Ansehen",
        date: "Datum",
        tags: "Tags"
    },
    ru: {
        title: "–ú–æ–∏ –ü–∏—Å—å–º–∞",
        addLetter: "–î–æ–±–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ",
        searchPlaceholder: "–ü–æ–∏—Å–∫ –ø–∏—Å–µ–º...",
        allDates: "–í—Å–µ –¥–∞—Ç—ã",
        today: "–°–µ–≥–æ–¥–Ω—è",
        thisWeek: "–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ",
        thisMonth: "–í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ",
        allTags: "–í—Å–µ —Ç–µ–≥–∏",
        important: "–í–∞–∂–Ω–æ–µ",
        personal: "–õ–∏—á–Ω–æ–µ",
        work: "–†–∞–±–æ—Ç–∞",
        reminder: "–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ",
        clearFilters: "–û—á–∏—Å—Ç–∏—Ç—å",
        deleteConfirm: "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è",
        deleteMessage: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å",
        letters: "–ø–∏—Å—å–º–æ(–∞)",
        warning: "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!",
        cancel: "–û—Ç–º–µ–Ω–∞",
        delete: "–£–¥–∞–ª–∏—Ç—å",
        editLetter: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∏—Å—å–º–æ",
        addLetterModal: "–î–æ–±–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ",
        titleLabel: "–ó–∞–≥–æ–ª–æ–≤–æ–∫",
        contentLabel: "–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ",
        tagsLabel: "–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)",
        tagsPlaceholder: "—Ä–∞–±–æ—Ç–∞, –≤–∞–∂–Ω–æ–µ, –ª–∏—á–Ω–æ–µ",
        save: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
        readMode: "–†–µ–∂–∏–º —á—Ç–µ–Ω–∏—è",
        theme: "–¢–µ–º–∞",
        lightTheme: "–°–≤–µ—Ç–ª–∞—è",
        darkTheme: "–¢–µ–º–Ω–∞—è",
        blueTheme: "–°–∏–Ω—è—è",
        greenTheme: "–ó–µ–ª–µ–Ω–∞—è",
        exportPDF: "–≠–∫—Å–ø–æ—Ä—Ç PDF",
        exportTXT: "–≠–∫—Å–ø–æ—Ä—Ç TXT",
        expand: "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å",
        collapse: "–°–≤–µ—Ä–Ω—É—Ç—å",
        noLetters: "–ù–µ—Ç –ø–∏—Å–µ–º",
        addFirstLetter: "–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–µ –ø–µ—Ä–≤–æ–µ –ø–∏—Å—å–º–æ",
        deleteSelected: "–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ",
        edit: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å",
        view: "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å",
        date: "–î–∞—Ç–∞",
        tags: "–¢–µ–≥–∏"
    },
    pl: {
        title: "Moje Listy",
        addLetter: "Dodaj list",
        searchPlaceholder: "Szukaj list√≥w...",
        allDates: "Wszystkie daty",
        today: "Dzi≈õ",
        thisWeek: "W tym tygodniu",
        thisMonth: "W tym miesiƒÖcu",
        allTags: "Wszystkie tagi",
        important: "Wa≈ºne",
        personal: "Osobiste",
        work: "Praca",
        reminder: "Przypomnienie",
        clearFilters: "Wyczy≈õƒá",
        deleteConfirm: "Potwierdzenie usuniƒôcia",
        deleteMessage: "Czy na pewno chcesz usunƒÖƒá",
        letters: "list(y)",
        warning: "Tej czynno≈õci nie mo≈ºna cofnƒÖƒá!",
        cancel: "Anuluj",
        delete: "Usu≈Ñ",
        editLetter: "Edytuj list",
        addLetterModal: "Dodaj list",
        titleLabel: "Tytu≈Ç",
        contentLabel: "Tre≈õƒá",
        tagsLabel: "Tagi (oddzielone przecinkami)",
        tagsPlaceholder: "praca, wa≈ºne, osobiste",
        save: "Zapisz",
        readMode: "Tryb czytania",
        theme: "Motyw",
        lightTheme: "Jasny",
        darkTheme: "Ciemny",
        blueTheme: "Niebieski",
        greenTheme: "Zielony",
        exportPDF: "Eksportuj PDF",
        exportTXT: "Eksportuj TXT",
        expand: "Rozwi≈Ñ",
        collapse: "Zwi≈Ñ",
        noLetters: "Brak list√≥w",
        addFirstLetter: "Dodaj sw√≥j pierwszy list",
        deleteSelected: "Usu≈Ñ wybrane",
        edit: "Edytuj",
        view: "Zobacz",
        date: "Data",
        tags: "Tagi"
    }
};

// –°—Ç–∞–Ω –¥–æ–¥–∞—Ç–∫—É
let letters = JSON.parse(localStorage.getItem('letters')) || [
    {
        id: 1,
        title: "–ü–µ—Ä—à–∏–π –ª–∏—Å—Ç",
        content: "–¶–µ –ø—Ä–∏–∫–ª–∞–¥ –ø–µ—Ä—à–æ–≥–æ –ª–∏—Å—Ç–∞. –¢—É—Ç –º–æ–∂–µ –±—É—Ç–∏ –≤–∞—à —Ç–µ–∫—Å—Ç. –í–∏ –º–æ–∂–µ—Ç–µ –¥–æ–¥–∞–≤–∞—Ç–∏ –ª–∏—Å—Ç–∏, —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ —ó—Ö, –µ–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —É —Ä—ñ–∑–Ω–∏—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö —Ç–∞ –Ω–∞–≤—ñ—Ç—å –≤–∏–¥–∞–ª—è—Ç–∏, —è–∫—â–æ –≤–æ–Ω–∏ –±—ñ–ª—å—à–µ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ.",
        date: new Date().toISOString(),
        tags: ["–ø—Ä–∏–∫–ª–∞–¥", "–ø–µ—Ä—à–∏–π"]
    },
    {
        id: 2,
        title: "–í–∞–∂–ª–∏–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è",
        content: "–¶–µ –≤–∞–∂–ª–∏–≤–∏–π –ª–∏—Å—Ç –∑ –¥–æ–≤–≥–∏–º —Ç–µ–∫—Å—Ç–æ–º, —è–∫–∏–π –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è —Ç–∞ –∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–Ω—Ç—É. –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –±–∞–≥–∞—Ç–æ —Ç–µ–∫—Å—Ç—É —Ç—É—Ç. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.",
        date: new Date(Date.now() - 86400000).toISOString(),
        tags: ["–≤–∞–∂–ª–∏–≤–µ", "—Ä–æ–±–æ—Ç–∞", "—Ç–µ—Ä–º—ñ–Ω–æ–≤–æ"]
    },
    {
        id: 3,
        title: "–û—Å–æ–±–∏—Å—Ç–∏–π —â–æ–¥–µ–Ω–Ω–∏–∫",
        content: "–°—å–æ–≥–æ–¥–Ω—ñ —á—É–¥–æ–≤–∏–π –¥–µ–Ω—å! –ü–æ–≥–æ–¥–∞ —Å–æ–Ω—è—á–Ω–∞, –Ω–∞—Å—Ç—Ä—ñ–π –≤—ñ–¥–º—ñ–Ω–Ω–∏–π. –ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ –±–∞–≥–∞—Ç–æ —Å–ø—Ä–∞–≤ –Ω–∞ –¥–µ–Ω—å, –∞–ª–µ —è –≤–ø–µ–≤–Ω–µ–Ω–∏–π, —â–æ –≤–ø–æ—Ä–∞—é—Å—è –∑ —É—Å—ñ–º–∞ –∑–∞–≤–¥–∞–Ω–Ω—è–º–∏.",
        date: new Date(Date.now() - 172800000).toISOString(),
        tags: ["–æ—Å–æ–±–∏—Å—Ç–µ", "—â–æ–¥–µ–Ω–Ω–∏–∫", "–Ω–∞—Å—Ç—Ä—ñ–π"]
    }
];

let currentLanguage = localStorage.getItem('language') || 'uk';
let currentTheme = localStorage.getItem('theme') || 'light';
let isReadMode = localStorage.getItem('readMode') === 'true';
let lettersToDelete = [];
let editingLetterId = null;

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
document.addEventListener('DOMContentLoaded', () => {
    initApp();
});

function initApp() {
    loadLanguage();
    loadTheme();
    loadReadMode();
    renderLetters();
    setupEventListeners();
    updateSelectedCount();
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–≤–∏
function loadLanguage() {
    const lang = localStorage.getItem('language') || 'uk';
    setLanguage(lang);
}

function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem('language', lang);
    document.documentElement.lang = lang;
    
    const translation = translations[lang];
    document.querySelector('title').textContent = translation.title;
    document.getElementById('appTitle').textContent = translation.title;
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—Å—ñ—Ö —Ç–µ–∫—Å—Ç–æ–≤ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤
    updateTextElements(translation);
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–∏–ø–∞–¥–∞—é—á–∏—Ö —Å–ø–∏—Å–∫—ñ–≤
    updateDropdowns(translation);
    
    // –û–Ω–æ–≤–∏—Ç–∏ –∞–∫—Ç–∏–≤–Ω—É –æ–ø—Ü—ñ—é –º–æ–≤–∏
    document.querySelectorAll('.lang-option').forEach(option => {
        option.classList.toggle('active', option.dataset.lang === lang);
    });
}

function updateTextElements(t) {
    // –û—Å–Ω–æ–≤–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏
    document.getElementById('searchInput').placeholder = t.searchPlaceholder;
    document.querySelector('.btn-text').textContent = t.addLetter;
    document.querySelector('.current-lang').textContent = getLanguageName(currentLanguage);
    document.querySelector('.current-theme').textContent = t.theme;
    
    // –§—ñ–ª—å—Ç—Ä–∏
    document.getElementById('dateFilter').innerHTML = `
        <option value="all">${t.allDates}</option>
        <option value="today">${t.today}</option>
        <option value="week">${t.thisWeek}</option>
        <option value="month">${t.thisMonth}</option>
    `;
    
    document.getElementById('tagFilter').innerHTML = `
        <option value="all">${t.allTags}</option>
        <option value="–≤–∞–∂–ª–∏–≤–µ">${t.important}</option>
        <option value="–æ—Å–æ–±–∏—Å—Ç–µ">${t.personal}</option>
        <option value="—Ä–æ–±–æ—Ç–∞">${t.work}</option>
        <option value="–Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è">${t.reminder}</option>
    `;
    
    document.querySelector('#clearFilters span').textContent = t.clearFilters;
    
    // –ú–æ–¥–∞–ª—å–Ω—ñ –≤—ñ–∫–Ω–∞
    document.getElementById('modalTitle').textContent = t.deleteConfirm;
    document.getElementById('editModalTitle').textContent = t.addLetterModal;
    
    // –§–æ—Ä–º–∞
    document.querySelector('label[for="letterTitle"]').textContent = t.titleLabel;
    document.querySelector('label[for="letterContent"]').textContent = t.contentLabel;
    document.querySelector('label[for="letterTags"]').textContent = t.tagsLabel;
    document.getElementById('letterTags').placeholder = t.tagsPlaceholder;
    
    // –ö–Ω–æ–ø–∫–∏ —Ñ–æ—Ä–º–∏
    const formButtons = document.querySelectorAll('#letterForm .btn');
    formButtons[0].textContent = t.cancel;
    formButtons[1].textContent = t.save;
    
    // –ö–Ω–æ–ø–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è
    const deleteButtons = document.querySelectorAll('#deleteModal .btn');
    deleteButtons[0].textContent = t.cancel;
    deleteButtons[1].querySelector('span').textContent = t.delete;
    
    // –û–Ω–æ–≤–∏—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
    if (editingLetterId) {
        document.getElementById('editModalTitle').textContent = t.editLetter;
    }
    
    // –û–Ω–æ–≤–∏—Ç–∏ –ª–∏—Å—Ç–∏
    renderLetters();
    
    // –û–Ω–æ–≤–∏—Ç–∏ –ø—É—Å—Ç–∏–π —Å—Ç–∞–Ω
    const emptyState = document.getElementById('emptyState');
    if (emptyState) {
        emptyState.querySelector('h3').textContent = t.noLetters;
        emptyState.querySelector('p').textContent = t.addFirstLetter;
    }
}

function getLanguageName(lang) {
    const names = {
        uk: 'üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞',
        en: 'üá∫üá∏ English',
        de: 'üá©üá™ Deutsch',
        ru: 'üá∑üá∫ –†—É—Å—Å–∫–∏–π',
        pl: 'üáµüá± Polski'
    };
    return names[lang] || names.uk;
}

function updateDropdowns(t) {
    const themeOptions = document.querySelectorAll('.theme-option span');
    if (themeOptions.length >= 4) {
        themeOptions[0].textContent = t.lightTheme;
        themeOptions[1].textContent = t.darkTheme;
        themeOptions[2].textContent = t.blueTheme;
        themeOptions[3].textContent = t.greenTheme;
    }
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–µ–º–∏
function loadTheme() {
    const theme = localStorage.getItem('theme') || 'light';
    setTheme(theme);
}

function setTheme(theme) {
    currentTheme = theme;
    localStorage.setItem('theme', theme);
    document.documentElement.setAttribute('data-theme', theme);
    
    // –û–Ω–æ–≤–∏—Ç–∏ —Ç–µ–∫—Å—Ç —Ç–µ–º–∏
    const themeName = translations[currentLanguage][`${theme}Theme`];
    document.querySelector('.current-theme').textContent = themeName;
    
    // –û–Ω–æ–≤–∏—Ç–∏ –∞–∫—Ç–∏–≤–Ω—É –æ–ø—Ü—ñ—é —Ç–µ–º–∏
    document.querySelectorAll('.theme-option').forEach(option => {
        option.classList.toggle('active', option.dataset.theme === theme);
    });
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ–∂–∏–º—É —á–∏—Ç–∞–Ω–Ω—è
function loadReadMode() {
    if (isReadMode) {
        document.body.classList.add('read-mode-active');
        document.getElementById('readModeToggle').classList.add('active');
        document.getElementById('readModeToggle').title = translations[currentLanguage].readMode;
    }
}

// –†–µ–Ω–¥–µ—Ä –ª–∏—Å—Ç—ñ–≤
function renderLetters(filteredLetters = letters) {
    const container = document.getElementById('lettersContainer');
    const emptyState = document.getElementById('emptyState');
    const t = translations[currentLanguage];
    
    if (filteredLetters.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'flex';
        return;
    }
    
    emptyState.style.display = 'none';
    
    container.innerHTML = filteredLetters.map(letter => {
        const isLongContent = letter.content.length > 200;
        const isExpanded = localStorage.getItem(`letter_${letter.id}_expanded`) === 'true';
        
        return `
        <div class="letter-card" data-id="${letter.id}">
            <div class="letter-header">
                <div class="letter-header-left">
                    <h3 class="letter-title">${escapeHtml(letter.title)}</h3>
                    <div class="letter-date">
                        <i class="far fa-calendar"></i> ${formatDate(letter.date, currentLanguage)}
                    </div>
                </div>
                <div class="letter-checkbox">
                    <input type="checkbox" class="select-letter" data-id="${letter.id}" id="check_${letter.id}">
                    <label for="check_${letter.id}" class="checkbox-label"></label>
                </div>
            </div>
            
            ${letter.tags.length > 0 ? `
            <div class="letter-tags">
                <i class="fas fa-tags"></i>
                ${letter.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
            </div>
            ` : ''}
            
            <div class="letter-content ${isExpanded ? 'expanded' : ''}" id="content-${letter.id}">
                ${escapeHtml(letter.content)}
                ${isLongContent ? `
                <div class="read-more">
                    <button class="btn-expand" onclick="toggleExpand(${letter.id})">
                        <i class="fas ${isExpanded ? 'fa-chevron-up' : 'fa-chevron-down'}"></i>
                        ${isExpanded ? t.collapse : t.expand}
                    </button>
                </div>
                ` : ''}
            </div>
            
            <div class="letter-actions">
                <button class="action-btn" onclick="editLetter(${letter.id})" title="${t.edit}">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn" onclick="exportAsPDF(${letter.id})" title="${t.exportPDF}">
                    <i class="fas fa-file-pdf"></i>
                </button>
                <button class="action-btn" onclick="exportAsTXT(${letter.id})" title="${t.exportTXT}">
                    <i class="fas fa-file-alt"></i>
                </button>
                <button class="action-btn delete-btn" onclick="showDeleteModal([${letter.id}])" title="${t.delete}">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        `;
    }).join('');
    
    // –î–æ–¥–∞—Ç–∏ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å—ñ–≤
    document.querySelectorAll('.select-letter').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });
}

// –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –¥–∞—Ç–∏
function formatDate(dateString, lang = 'uk') {
    const date = new Date(dateString);
    const localeMap = {
        'uk': 'uk-UA',
        'ru': 'ru-RU',
        'en': 'en-US',
        'de': 'de-DE',
        'pl': 'pl-PL'
    };
    
    return date.toLocaleDateString(localeMap[lang] || 'uk-UA', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// –ï–∫—Ä–∞–Ω—É–≤–∞–Ω–Ω—è HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// –ü–æ—à—É–∫ —Ç–∞ —Ñ—ñ–ª—å—Ç—Ä–∏
function searchAndFilter() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const dateFilter = document.getElementById('dateFilter').value;
    const tagFilter = document.getElementById('tagFilter').value;
    
    const now = new Date();
    const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const startOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    
    const filtered = letters.filter(letter => {
        // –ü–æ—à—É–∫
        const matchesSearch = !searchTerm || 
            letter.title.toLowerCase().includes(searchTerm) ||
            letter.content.toLowerCase().includes(searchTerm) ||
            letter.tags.some(tag => tag.toLowerCase().includes(searchTerm));
        
        // –§—ñ–ª—å—Ç—Ä –∑–∞ –¥–∞—Ç–æ—é
        let matchesDate = true;
        const letterDate = new Date(letter.date);
        
        if (dateFilter === 'today') {
            matchesDate = letterDate >= startOfDay;
        } else if (dateFilter === 'week') {
            matchesDate = letterDate >= startOfWeek;
        } else if (dateFilter === 'month') {
            matchesDate = letterDate >= startOfMonth;
        }
        
        // –§—ñ–ª—å—Ç—Ä –∑–∞ —Ç–µ–≥–æ–º
        let matchesTag = true;
        if (tagFilter !== 'all') {
            matchesTag = letter.tags.map(t => t.toLowerCase()).includes(tagFilter.toLowerCase());
        }
        
        return matchesSearch && matchesDate && matchesTag;
    });
    
    renderLetters(filtered);
}

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ –≤–∏–±—Ä–∞–Ω–∏—Ö –ª–∏—Å—Ç—ñ–≤
function updateSelectedCount() {
    const selected = document.querySelectorAll('.select-letter:checked');
    const deleteBtn = document.querySelector('.delete-selected-btn');
    
    if (selected.length > 0) {
        if (!deleteBtn) {
            const deleteSelectedBtn = document.createElement('button');
            deleteSelectedBtn.className = 'btn btn-danger delete-selected-btn';
            deleteSelectedBtn.innerHTML = `<i class="fas fa-trash"></i> ${translations[currentLanguage].deleteSelected} (${selected.length})`;
            deleteSelectedBtn.onclick = () => showDeleteModal();
            document.querySelector('.filters').appendChild(deleteSelectedBtn);
        } else {
            deleteSelectedBtn.innerHTML = `<i class="fas fa-trash"></i> ${translations[currentLanguage].deleteSelected} (${selected.length})`;
        }
    } else if (deleteBtn) {
        deleteBtn.remove();
    }
}

// –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è
function showDeleteModal(letterIds = []) {
    if (letterIds.length === 0) {
        // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤–∏–±—Ä–∞–Ω—ñ —á–µ–∫–±–æ–∫—Å–∏
        const selected = document.querySelectorAll('.select-letter:checked');
        letterIds = Array.from(selected).map(cb => parseInt(cb.dataset.id));
        
        if (letterIds.length === 0) {
            alert('–í–∏–±–µ—Ä—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–∏–Ω –ª–∏—Å—Ç –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è');
            return;
        }
    }
    
    lettersToDelete = letterIds;
    const t = translations[currentLanguage];
    
    document.getElementById('itemCount').textContent = letterIds.length;
    document.getElementById('deleteMessage').innerHTML = `
        ${t.deleteMessage} <span id="itemCount">${letterIds.length}</span> ${t.letters}?
    `;
    document.getElementById('modalTitle').textContent = t.deleteConfirm;
    document.querySelector('#confirmDelete span').textContent = t.delete;
    document.getElementById('deleteModal').style.display = 'flex';
}

// –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è
function confirmDelete() {
    letters = letters.filter(letter => !lettersToDelete.includes(letter.id));
    localStorage.setItem('letters', JSON.stringify(letters));
    renderLetters();
    hideDeleteModal();
    
    // –í–∏–¥–∞–ª–∏—Ç–∏ –∫–Ω–æ–ø–∫—É –≤–∏–¥–∞–ª–µ–Ω–Ω—è –≤–∏–±—Ä–∞–Ω–∏—Ö
    const deleteSelectedBtn = document.querySelector('.delete-selected-btn');
    if (deleteSelectedBtn) {
        deleteSelectedBtn.remove();
    }
}

function hideDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
    lettersToDelete = [];
    
    // –°–∫–∏–Ω—É—Ç–∏ –≤—Å—ñ —á–µ–∫–±–æ–∫—Å–∏
    document.querySelectorAll('.select-letter').forEach(cb => {
        cb.checked = false;
    });
    
    updateSelectedCount();
}

// –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ª–∏—Å—Ç–∞
function editLetter(id) {
    const letter = letters.find(l => l.id === id);
    if (!letter) return;
    
    editingLetterId = id;
    const t = translations[currentLanguage];
    
    document.getElementById('editModalTitle').textContent = t.editLetter;
    document.getElementById('letterTitle').value = letter.title;
    document.getElementById('letterContent').value = letter.content;
    document.getElementById('letterTags').value = letter.tags.join(', ');
    document.getElementById('editModal').style.display = 'flex';
}

function saveLetter(e) {
    e.preventDefault();
    
    const title = document.getElementById('letterTitle').value.trim();
    const content = document.getElementById('letterContent').value.trim();
    const tags = document.getElementById('letterTags').value
        .split(',')
        .map(tag => tag.trim())
        .filter(tag => tag.length > 0);
    
    if (!title || !content) {
        alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è');
        return;
    }
    
    if (editingLetterId) {
        // –û–Ω–æ–≤–∏—Ç–∏ —ñ—Å–Ω—É—é—á–∏–π –ª–∏—Å—Ç
        const index = letters.findIndex(l => l.id === editingLetterId);
        if (index !== -1) {
            letters[index] = {
                ...letters[index],
                title,
                content,
                tags,
                date: new Date().toISOString()
            };
        }
        editingLetterId = null;
    } else {
        // –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –ª–∏—Å—Ç
        const newLetter = {
            id: Date.now(),
            title,
            content,
            tags,
            date: new Date().toISOString()
        };
        letters.unshift(newLetter);
    }
    
    localStorage.setItem('letters', JSON.stringify(letters));
    renderLetters();
    hideEditModal();
}

function hideEditModal() {
    document.getElementById('editModal').style.display = 'none';
    document.getElementById('letterForm').reset();
    editingLetterId = null;
    document.getElementById('editModalTitle').textContent = translations[currentLanguage].addLetterModal;
}

// –ï–∫—Å–ø–æ—Ä—Ç
function exportAsPDF(id) {
    const letter = letters.find(l => l.id === id);
    if (!letter) return;
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(20);
    doc.text(letter.title, 20, 20);
    
    doc.setFontSize(12);
    doc.text(`${translations[currentLanguage].date}: ${formatDate(letter.date, currentLanguage)}`, 20, 35);
    
    if (letter.tags.length > 0) {
        doc.text(`${translations[currentLanguage].tags}: ${letter.tags.join(', ')}`, 20, 45);
    }
    
    doc.setFontSize(14);
    const lines = doc.splitTextToSize(letter.content, 170);
    doc.text(lines, 20, 60);
    
    doc.save(`${letter.title.replace(/[^a-z0-9]/gi, '_')}.pdf`);
}

function exportAsTXT(id) {
    const letter = letters.find(l => l.id === id);
    if (!letter) return;
    
    const t = translations[currentLanguage];
    const content = `
${letter.title}
${'='.repeat(letter.title.length)}

${t.date}: ${formatDate(letter.date, currentLanguage)}
${t.tags}: ${letter.tags.join(', ')}

${letter.content}
    `.trim();
    
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${letter.title.replace(/[^a-z0-9]/gi, '_')}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

// –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è/–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–Ω—Ç—É
function toggleExpand(id) {
    const content = document.getElementById(`content-${id}`);
    const button = content.querySelector('.btn-expand');
    const icon = button.querySelector('i');
    const t = translations[currentLanguage];
    
    if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        icon.className = 'fas fa-chevron-down';
        button.innerHTML = `<i class="fas fa-chevron-down"></i> ${t.expand}`;
        localStorage.setItem(`letter_${id}_expanded`, 'false');
    } else {
        content.classList.add('expanded');
        icon.className = 'fas fa-chevron-up';
        button.innerHTML = `<i class="fas fa-chevron-up"></i> ${t.collapse}`;
        localStorage.setItem(`letter_${id}_expanded`, 'true');
    }
}

// –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –ø–æ–¥—ñ–π
function setupEventListeners() {
    // –ü–æ—à—É–∫ —Ç–∞ —Ñ—ñ–ª—å—Ç—Ä–∏
    document.getElementById('searchInput').addEventListener('input', searchAndFilter);
    document.getElementById('dateFilter').addEventListener('change', searchAndFilter);
    document.getElementById('tagFilter').addEventListener('change', searchAndFilter);
    document.getElementById('clearFilters').addEventListener('click', () => {
        document.getElementById('searchInput').value = '';
        document.getElementById('dateFilter').value = 'all';
        document.getElementById('tagFilter').value = 'all';
        searchAndFilter();
    });
    
    // –î–æ–¥–∞—Ç–∏ –ª–∏—Å—Ç
    document.getElementById('addLetterBtn').addEventListener('click', () => {
        editingLetterId = null;
        const t = translations[currentLanguage];
        document.getElementById('editModalTitle').textContent = t.addLetterModal;
        document.getElementById('letterForm').reset();
        document.getElementById('editModal').style.display = 'flex';
    });
    
    // –§–æ—Ä–º–∞ –ª–∏—Å—Ç–∞
    document.getElementById('letterForm').addEventListener('submit', saveLetter);
    
    // –ú–æ–¥–∞–ª—å–Ω—ñ –≤—ñ–∫–Ω–∞
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', hideDeleteModal);
    });
    
    document.querySelectorAll('.close-edit-modal').forEach(btn => {
        btn.addEventListener('click', hideEditModal);
    });
    
    document.getElementById('confirmDelete').addEventListener('click', confirmDelete);
    
    // –í–∏–±—ñ—Ä –º–æ–≤–∏
    document.querySelectorAll('.lang-option').forEach(option => {
        option.addEventListener('click', (e) => {
            e.stopPropagation();
            const lang = option.dataset.lang;
            setLanguage(lang);
            document.querySelector('.current-lang').textContent = getLanguageName(lang);
        });
    });
    
    // –í–∏–±—ñ—Ä —Ç–µ–º–∏
    document.querySelectorAll('.theme-option').forEach(option => {
        option.addEventListener('click', (e) => {
            e.stopPropagation();
            const theme = option.dataset.theme;
            setTheme(theme);
        });
    });
    
    // –†–µ–∂–∏–º —á–∏—Ç–∞–Ω–Ω—è
    document.getElementById('readModeToggle').addEventListener('click', () => {
        isReadMode = !isReadMode;
        document.body.classList.toggle('read-mode-active', isReadMode);
        document.getElementById('readModeToggle').classList.toggle('active', isReadMode);
        localStorage.setItem('readMode', isReadMode);
        
        // –û–Ω–æ–≤–∏—Ç–∏ –ø—ñ–¥–∫–∞–∑–∫—É
        const title = translations[currentLanguage].readMode;
        document.getElementById('readModeToggle').title = title;
    });
    
    // –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–∏—Ö –≤—ñ–∫–æ–Ω –ø–æ –∫–ª—ñ–∫—É –Ω–∞ —Ç–ª–æ
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
                if (modal.id === 'editModal') {
                    hideEditModal();
                } else if (modal.id === 'deleteModal') {
                    hideDeleteModal();
                }
            }
        });
    });
    
    // –û–±—Ä–æ–±–∫–∞ –∫–ª–∞–≤—ñ—à—ñ Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            hideDeleteModal();
            hideEditModal();
        }
    });
    
    // –ó–∞–∫—Ä–∏—Ç—Ç—è –¥—Ä–æ–ø–¥–∞—É–Ω—ñ–≤ –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º–∏
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.dropdown')) {
            document.querySelectorAll('.dropdown-content').forEach(content => {
                content.style.display = 'none';
            });
        }
    });
    
    // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –¥—Ä–æ–ø–¥–∞—É–Ω—ñ–≤
    document.querySelectorAll('.dropdown-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const content = btn.nextElementSibling;
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
        });
    });
}

// –ì–ª–æ–±–∞–ª—å–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è HTML –∞—Ç—Ä–∏–±—É—Ç—ñ–≤ onclick
window.toggleExpand = toggleExpand;
window.editLetter = editLetter;
window.exportAsPDF = exportAsPDF;
window.exportAsTXT = exportAsTXT;
window.showDeleteModal = showDeleteModal;
