// –ú–æ–≤–∏ —Ç–∞ –ø–µ—Ä–µ–∫–ª–∞–¥–∏
const translations = {
    uk: {
        title: "–ú–æ—ó –õ–∏—Å—Ç–∏",
        addLetter: "–î–æ–¥–∞—Ç–∏ –ª–∏—Å—Ç",
        searchPlaceholder: "–ü–æ—à—É–∫ –ª–∏—Å—Ç—ñ–≤...",
        allDates: "–£—Å—ñ –¥–∞—Ç–∏",
        today: "–°—å–æ–≥–æ–¥–Ω—ñ",
        thisWeek: "–¶—å–æ–≥–æ —Ç–∏–∂–Ω—è",
        thisMonth: "–¶—å–æ–≥–æ –º—ñ—Å—è—Ü—è",
        allTags: "–£—Å—ñ —Ç–µ–≥–∏",
        important: "–í–∞–∂–ª–∏–≤–µ",
        personal: "–û—Å–æ–±–∏—Å—Ç–µ",
        work: "–†–æ–±–æ—Ç–∞",
        clearFilters: "–û—á–∏—Å—Ç–∏—Ç–∏",
        deleteConfirm: "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è",
        deleteMessage: "–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏",
        letters: "–ª–∏—Å—Ç(–∏)",
        warning: "–¶—é –¥—ñ—é –Ω–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏!",
        cancel: "–°–∫–∞—Å—É–≤–∞—Ç–∏",
        delete: "–í–∏–¥–∞–ª–∏—Ç–∏",
        editLetter: "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ª–∏—Å—Ç",
        addLetterModal: "–î–æ–¥–∞—Ç–∏ –ª–∏—Å—Ç",
        titleLabel: "–ó–∞–≥–æ–ª–æ–≤–æ–∫",
        contentLabel: "–ó–º—ñ—Å—Ç",
        tagsLabel: "–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∫–æ–º—É)",
        tagsPlaceholder: "—Ä–æ–±–æ—Ç–∞, –≤–∞–∂–ª–∏–≤–µ, –æ—Å–æ–±–∏—Å—Ç–µ",
        save: "–ó–±–µ—Ä–µ–≥—Ç–∏",
        readMode: "–†–µ–∂–∏–º —á–∏—Ç–∞–Ω–Ω—è",
        theme: "–¢–µ–º–∞",
        lightTheme: "–°–≤—ñ—Ç–ª–∞",
        darkTheme: "–¢–µ–º–Ω–∞",
        blueTheme: "–°–∏–Ω—è",
        greenTheme: "–ó–µ–ª–µ–Ω–∞",
        exportPDF: "–ï–∫—Å–ø–æ—Ä—Ç PDF",
        exportTXT: "–ï–∫—Å–ø–æ—Ä—Ç TXT",
        expand: "–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏",
        collapse: "–ó–≥–æ—Ä–Ω—É—Ç–∏",
        noLetters: "–ù–µ–º–∞—î –ª–∏—Å—Ç—ñ–≤",
        addFirstLetter: "–î–æ–¥–∞–π—Ç–µ —Å–≤—ñ–π –ø–µ—Ä—à–∏–π –ª–∏—Å—Ç"
    },
    en: {
        title: "My Letters",
        addLetter: "Add Letter",
        searchPlaceholder: "Search letters...",
        allDates: "All dates",
        today: "Today",
        thisWeek: "This week",
        thisMonth: "This month",
        allTags: "All tags",
        important: "Important",
        personal: "Personal",
        work: "Work",
        clearFilters: "Clear",
        deleteConfirm: "Delete Confirmation",
        deleteMessage: "Are you sure you want to delete",
        letters: "letter(s)",
        warning: "This action cannot be undone!",
        cancel: "Cancel",
        delete: "Delete",
        editLetter: "Edit Letter",
        addLetterModal: "Add Letter",
        titleLabel: "Title",
        contentLabel: "Content",
        tagsLabel: "Tags (comma separated)",
        tagsPlaceholder: "work, important, personal",
        save: "Save",
        readMode: "Reading Mode",
        theme: "Theme",
        lightTheme: "Light",
        darkTheme: "Dark",
        blueTheme: "Blue",
        greenTheme: "Green",
        exportPDF: "Export PDF",
        exportTXT: "Export TXT",
        expand: "Expand",
        collapse: "Collapse",
        noLetters: "No letters",
        addFirstLetter: "Add your first letter"
    },
    pl: {
        title: "Moje Listy",
        addLetter: "Dodaj list",
        searchPlaceholder: "Szukaj list√≥w...",
        allDates: "Wszystkie daty",
        today: "Dzi≈õ",
        thisWeek: "W tym tygodniu",
        thisMonth: "W tym miesiƒÖcu",
        allTags: "Wszystkie tagi",
        important: "Wa≈ºne",
        personal: "Osobiste",
        work: "Praca",
        clearFilters: "Wyczy≈õƒá",
        deleteConfirm: "Potwierdzenie usuniƒôcia",
        deleteMessage: "Czy na pewno chcesz usunƒÖƒá",
        letters: "list(y)",
        warning: "Tej czynno≈õci nie mo≈ºna cofnƒÖƒá!",
        cancel: "Anuluj",
        delete: "Usu≈Ñ",
        editLetter: "Edytuj list",
        addLetterModal: "Dodaj list",
        titleLabel: "Tytu≈Ç",
        contentLabel: "Tre≈õƒá",
        tagsLabel: "Tagi (oddzielone przecinkami)",
        tagsPlaceholder: "praca, wa≈ºne, osobiste",
        save: "Zapisz",
        readMode: "Tryb czytania",
        theme: "Motyw",
        lightTheme: "Jasny",
        darkTheme: "Ciemny",
        blueTheme: "Niebieski",
        greenTheme: "Zielony",
        exportPDF: "Eksportuj PDF",
        exportTXT: "Eksportuj TXT",
        expand: "Rozwi≈Ñ",
        collapse: "Zwi≈Ñ",
        noLetters: "Brak list√≥w",
        addFirstLetter: "Dodaj sw√≥j pierwszy list"
    },
    de: {
        title: "Meine Briefe",
        addLetter: "Brief hinzuf√ºgen",
        searchPlaceholder: "Briefe suchen...",
        allDates: "Alle Daten",
        today: "Heute",
        thisWeek: "Diese Woche",
        thisMonth: "Diesen Monat",
        allTags: "Alle Tags",
        important: "Wichtig",
        personal: "Pers√∂nlich",
        work: "Arbeit",
        clearFilters: "L√∂schen",
        deleteConfirm: "L√∂schbest√§tigung",
        deleteMessage: "Sind Sie sicher, dass Sie l√∂schen m√∂chten",
        letters: "Brief(e)",
        warning: "Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!",
        cancel: "Abbrechen",
        delete: "L√∂schen",
        editLetter: "Brief bearbeiten",
        addLetterModal: "Brief hinzuf√ºgen",
        titleLabel: "Titel",
        contentLabel: "Inhalt",
        tagsLabel: "Tags (kommagetrennt)",
        tagsPlaceholder: "Arbeit, wichtig, pers√∂nlich",
        save: "Speichern",
        readMode: "Lesemodus",
        theme: "Thema",
        lightTheme: "Hell",
        darkTheme: "Dunkel",
        blueTheme: "Blau",
        greenTheme: "Gr√ºn",
        exportPDF: "PDF exportieren",
        exportTXT: "TXT exportieren",
        expand: "Erweitern",
        collapse: "Zusammenklappen",
        noLetters: "Keine Briefe",
        addFirstLetter: "F√ºgen Sie Ihren ersten Brief hinzu"
    }
};

// –°—Ç–∞–Ω –¥–æ–¥–∞—Ç–∫—É
let letters = JSON.parse(localStorage.getItem('letters')) || [
    {
        id: 1,
        title: "–ü–µ—Ä—à–∏–π –ª–∏—Å—Ç",
        content: "–¶–µ –ø—Ä–∏–∫–ª–∞–¥ –ø–µ—Ä—à–æ–≥–æ –ª–∏—Å—Ç–∞. –¢—É—Ç –º–æ–∂–µ –±—É—Ç–∏ –≤–∞—à —Ç–µ–∫—Å—Ç.",
        date: new Date().toISOString(),
        tags: ["–ø—Ä–∏–∫–ª–∞–¥", "–ø–µ—Ä—à–∏–π"]
    },
    {
        id: 2,
        title: "–í–∞–∂–ª–∏–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è",
        content: "–¶–µ –≤–∞–∂–ª–∏–≤–∏–π –ª–∏—Å—Ç –∑ –¥–æ–≤–≥–∏–º —Ç–µ–∫—Å—Ç–æ–º, —è–∫–∏–π –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è —Ç–∞ –∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–Ω—Ç—É. –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –±–∞–≥–∞—Ç–æ —Ç–µ–∫—Å—Ç—É —Ç—É—Ç.",
        date: new Date(Date.now() - 86400000).toISOString(),
        tags: ["–≤–∞–∂–ª–∏–≤–µ", "—Ä–æ–±–æ—Ç–∞"]
    }
];

let currentLanguage = localStorage.getItem('language') || 'uk';
let currentTheme = localStorage.getItem('theme') || 'light';
let isReadMode = localStorage.getItem('readMode') === 'true';
let lettersToDelete = [];
let editingLetterId = null;

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
document.addEventListener('DOMContentLoaded', () => {
    initApp();
});

function initApp() {
    loadLanguage();
    loadTheme();
    loadReadMode();
    renderLetters();
    setupEventListeners();
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–≤–∏
function loadLanguage() {
    const lang = localStorage.getItem('language') || 'uk';
    setLanguage(lang);
}

function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem('language', lang);
    document.documentElement.lang = lang;
    
    const translation = translations[lang];
    document.querySelector('title').textContent = translation.title;
    document.querySelector('h1').innerHTML = `<i class="fas fa-envelope"></i> ${translation.title}`;
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—Å—ñ—Ö —Ç–µ–∫—Å—Ç–æ–≤ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤
    updateTextElements(translation);
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–∏–ø–∞–¥–∞—é—á–∏—Ö —Å–ø–∏—Å–∫—ñ–≤
    updateDropdowns(translation);
}

function updateTextElements(t) {
    // –û—Å–Ω–æ–≤–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏
    document.getElementById('searchInput').placeholder = t.searchPlaceholder;
    document.querySelector('#addLetterBtn').innerHTML = `<i class="fas fa-plus"></i> ${t.addLetter}`;
    document.querySelector('.current-lang').textContent = getLanguageName(currentLanguage);
    document.querySelector('.current-theme').textContent = t.theme;
    
    // –§—ñ–ª—å—Ç—Ä–∏
    document.getElementById('dateFilter').innerHTML = `
        <option value="all">${t.allDates}</option>
        <option value="today">${t.today}</option>
        <option value="week">${t.thisWeek}</option>
        <option value="month">${t.thisMonth}</option>
    `;
    
    document.getElementById('tagFilter').innerHTML = `
        <option value="all">${t.allTags}</option>
        <option value="important">${t.important}</option>
        <option value="personal">${t.personal}</option>
        <option value="work">${t.work}</option>
    `;
    
    document.querySelector('#clearFilters').innerHTML = `<i class="fas fa-times"></i> ${t.clearFilters}`;
    
    // –ú–æ–¥–∞–ª—å–Ω—ñ –≤—ñ–∫–Ω–∞
    document.getElementById('modalTitle').textContent = t.deleteConfirm;
    document.getElementById('editModalTitle').textContent = t.addLetterModal;
    
    // –§–æ—Ä–º–∞
    document.querySelector('label[for="letterTitle"]').textContent = t.titleLabel;
    document.querySelector('label[for="letterContent"]').textContent = t.contentLabel;
    document.querySelector('label[for="letterTags"]').textContent = t.tagsLabel;
    document.getElementById('letterTags').placeholder = t.tagsPlaceholder;
    
    // –ö–Ω–æ–ø–∫–∏ —Ñ–æ—Ä–º–∏
    const formButtons = document.querySelectorAll('#letterForm .btn');
    formButtons[0].textContent = t.cancel;
    formButtons[1].textContent = t.save;
    
    // –ö–Ω–æ–ø–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è
    const deleteButtons = document.querySelectorAll('#deleteModal .btn');
    deleteButtons[0].textContent = t.cancel;
    deleteButtons[1].innerHTML = `<i class="fas fa-trash"></i> ${t.delete}`;
    
    // –û–Ω–æ–≤–∏—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
    if (editingLetterId) {
        document.getElementById('editModalTitle').textContent = t.editLetter;
    }
    
    // –û–Ω–æ–≤–∏—Ç–∏ –ª–∏—Å—Ç–∏
    renderLetters();
}

function getLanguageName(lang) {
    const names = {
        uk: 'üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞',
        en: 'üá∫üá∏ English',
        pl: 'üáµüá± Polski',
        de: 'üá©üá™ Deutsch'
    };
    return names[lang] || names.uk;
}

function updateDropdowns(t) {
    const themeOptions = document.querySelectorAll('.theme-option');
    themeOptions[0].innerHTML = `<i class="fas fa-sun"></i> ${t.lightTheme}`;
    themeOptions[1].innerHTML = `<i class="fas fa-moon"></i> ${t.darkTheme}`;
    themeOptions[2].innerHTML = `<i class="fas fa-droplet" style="color: #1e90ff;"></i> ${t.blueTheme}`;
    themeOptions[3].innerHTML = `<i class="fas fa-leaf" style="color: #27ae60;"></i> ${t.greenTheme}`;
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–µ–º–∏
function loadTheme() {
    const theme = localStorage.getItem('theme') || 'light';
    setTheme(theme);
}

function setTheme(theme) {
    currentTheme = theme;
    localStorage.setItem('theme', theme);
    document.documentElement.setAttribute('data-theme', theme);
    
    // –û–Ω–æ–≤–∏—Ç–∏ –∞–∫—Ç–∏–≤–Ω—É –æ–ø—Ü—ñ—é —Ç–µ–º–∏
    document.querySelectorAll('.theme-option').forEach(option => {
        option.classList.toggle('active', option.dataset.theme === theme);
    });
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ–∂–∏–º—É —á–∏—Ç–∞–Ω–Ω—è
function loadReadMode() {
    if (isReadMode) {
        document.body.classList.add('read-mode-active');
        document.getElementById('readModeToggle').classList.add('active');
    }
}

// –†–µ–Ω–¥–µ—Ä –ª–∏—Å—Ç—ñ–≤
function renderLetters(filteredLetters = letters) {
    const container = document.getElementById('lettersContainer');
    const emptyState = document.getElementById('emptyState');
    const t = translations[currentLanguage];
    
    if (filteredLetters.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        emptyState.querySelector('h3').textContent = t.noLetters;
        emptyState.querySelector('p').textContent = t.addFirstLetter;
        return;
    }
    
    emptyState.style.display = 'none';
    
    container.innerHTML = filteredLetters.map(letter => `
        <div class="letter-card" data-id="${letter.id}">
            <div class="letter-header">
                <div>
                    <h3 class="letter-title">${escapeHtml(letter.title)}</h3>
                    <div class="letter-date">${formatDate(letter.date)}</div>
                </div>
                <div class="letter-checkbox">
                    <input type="checkbox" class="select-letter" data-id="${letter.id}">
                </div>
            </div>
            
            <div class="letter-tags">
                ${letter.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
            </div>
            
            <div class="letter-content" id="content-${letter.id}">
                ${escapeHtml(letter.content)}
                ${letter.content.length > 200 ? `<div class="read-more"><button class="btn-expand" onclick="toggleExpand(${letter.id})">${t.expand}</button></div>` : ''}
            </div>
            
            <div class="letter-actions">
                <button class="action-btn" onclick="editLetter(${letter.id})" title="${t.editLetter}">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn" onclick="exportAsPDF(${letter.id})" title="${t.exportPDF}">
                    <i class="fas fa-file-pdf"></i>
                </button>
                <button class="action-btn" onclick="exportAsTXT(${letter.id})" title="${t.exportTXT}">
                    <i class="fas fa-file-alt"></i>
                </button>
                <button class="action-btn" onclick="showDeleteModal([${letter.id}])" title="${t.delete}">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
}

// –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –¥–∞—Ç–∏
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString(currentLanguage === 'uk' ? 'uk-UA' : currentLanguage, {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// –ï–∫—Ä–∞–Ω—É–≤–∞–Ω–Ω—è HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// –ü–æ—à—É–∫ —Ç–∞ —Ñ—ñ–ª—å—Ç—Ä–∏
function searchAndFilter() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const dateFilter = document.getElementById('dateFilter').value;
    const tagFilter = document.getElementById('tagFilter').value;
    
    const now = new Date();
    const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const startOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    
    const filtered = letters.filter(letter => {
        // –ü–æ—à—É–∫
        const matchesSearch = !searchTerm || 
            letter.title.toLowerCase().includes(searchTerm) ||
            letter.content.toLowerCase().includes(searchTerm) ||
            letter.tags.some(tag => tag.toLowerCase().includes(searchTerm));
        
        // –§—ñ–ª—å—Ç—Ä –∑–∞ –¥–∞—Ç–æ—é
        let matchesDate = true;
        const letterDate = new Date(letter.date);
        
        if (dateFilter === 'today') {
            matchesDate = letterDate >= startOfDay;
        } else if (dateFilter === 'week') {
            matchesDate = letterDate >= startOfWeek;
        } else if (dateFilter === 'month') {
            matchesDate = letterDate >= startOfMonth;
        }
        
        // –§—ñ–ª—å—Ç—Ä –∑–∞ —Ç–µ–≥–æ–º
        let matchesTag = true;
        if (tagFilter !== 'all') {
            matchesTag = letter.tags.map(t => t.toLowerCase()).includes(tagFilter);
        }
        
        return matchesSearch && matchesDate && matchesTag;
    });
    
    renderLetters(filtered);
}

// –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è
function showDeleteModal(letterIds = []) {
    lettersToDelete = letterIds;
    const t = translations[currentLanguage];
    
    if (letterIds.length === 0) {
        // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤–∏–±—Ä–∞–Ω—ñ —á–µ–∫–±–æ–∫—Å–∏
        const selected = document.querySelectorAll('.select-letter:checked');
        letterIds = Array.from(selected).map(cb => parseInt(cb.dataset.id));
        
        if (letterIds.length === 0) {
            alert('–í–∏–±–µ—Ä—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–∏–Ω –ª–∏—Å—Ç –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è');
            return;
        }
    }
    
    lettersToDelete = letterIds;
    document.getElementById('itemCount').textContent = letterIds.length;
    document.getElementById('deleteMessage').innerHTML = `
        ${t.deleteMessage} <span id="itemCount">${letterIds.length}</span> ${t.letters}?
    `;
    document.getElementById('deleteModal').style.display = 'flex';
}

// –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è
function confirmDelete() {
    letters = letters.filter(letter => !lettersToDelete.includes(letter.id));
    localStorage.setItem('letters', JSON.stringify(letters));
    renderLetters();
    hideDeleteModal();
}

function hideDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
    lettersToDelete = [];
    
    // –°–∫–∏–Ω—É—Ç–∏ –≤—Å—ñ —á–µ–∫–±–æ–∫—Å–∏
    document.querySelectorAll('.select-letter').forEach(cb => cb.checked = false);
}

// –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ª–∏—Å—Ç–∞
function editLetter(id) {
    const letter = letters.find(l => l.id === id);
    if (!letter) return;
    
    editingLetterId = id;
    const t = translations[currentLanguage];
    
    document.getElementById('editModalTitle').textContent = t.editLetter;
    document.getElementById('letterTitle').value = letter.title;
    document.getElementById('letterContent').value = letter.content;
    document.getElementById('letterTags').value = letter.tags.join(', ');
    document.getElementById('editModal').style.display = 'flex';
}

function saveLetter(e) {
    e.preventDefault();
    
    const title = document.getElementById('letterTitle').value.trim();
    const content = document.getElementById('letterContent').value.trim();
    const tags = document.getElementById('letterTags').value
        .split(',')
        .map(tag => tag.trim())
        .filter(tag => tag.length > 0);
    
    if (!title || !content) {
        alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è');
        return;
    }
    
    if (editingLetterId) {
        // –û–Ω–æ–≤–∏—Ç–∏ —ñ—Å–Ω—É—é—á–∏–π –ª–∏—Å—Ç
        const index = letters.findIndex(l => l.id === editingLetterId);
        if (index !== -1) {
            letters[index] = {
                ...letters[index],
                title,
                content,
                tags,
                date: new Date().toISOString()
            };
        }
        editingLetterId = null;
    } else {
        // –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –ª–∏—Å—Ç
        const newLetter = {
            id: Date.now(),
            title,
            content,
            tags,
            date: new Date().toISOString()
        };
        letters.unshift(newLetter);
    }
    
    localStorage.setItem('letters', JSON.stringify(letters));
    renderLetters();
    hideEditModal();
}

function hideEditModal() {
    document.getElementById('editModal').style.display = 'none';
    document.getElementById('letterForm').reset();
    editingLetterId = null;
}

// –ï–∫—Å–ø–æ—Ä—Ç
function exportAsPDF(id) {
    const letter = letters.find(l => l.id === id);
    if (!letter) return;
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(20);
    doc.text(letter.title, 20, 20);
    
    doc.setFontSize(12);
    doc.text(`–î–∞—Ç–∞: ${formatDate(letter.date)}`, 20, 35);
    
    if (letter.tags.length > 0) {
        doc.text(`–¢–µ–≥–∏: ${letter.tags.join(', ')}`, 20, 45);
    }
    
    doc.setFontSize(14);
    const lines = doc.splitTextToSize(letter.content, 170);
    doc.text(lines, 20, 60);
    
    doc.save(`–ª–∏—Å—Ç_${letter.id}.pdf`);
}

function exportAsTXT(id) {
    const letter = letters.find(l => l.id === id);
    if (!letter) return;
    
    const content = `
${letter.title}
${'='.repeat(letter.title.length)}

–î–∞—Ç–∞: ${formatDate(letter.date)}
–¢–µ–≥–∏: ${letter.tags.join(', ')}

${letter.content}
    `.trim();
    
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `–ª–∏—Å—Ç_${letter.id}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

// –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è/–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–Ω—Ç—É
function toggleExpand(id) {
    const content = document.getElementById(`content-${id}`);
    const button = content.querySelector('.btn-expand');
    const t = translations[currentLanguage];
    
    if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        button.textContent = t.expand;
    } else {
        content.classList.add('expanded');
        button.textContent = t.collapse;
    }
}

// –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –ø–æ–¥—ñ–π
function setupEventListeners() {
    // –ü–æ—à—É–∫ —Ç–∞ —Ñ—ñ–ª—å—Ç—Ä–∏
    document.getElementById('searchInput').addEventListener('input', searchAndFilter);
    document.getElementById('dateFilter').addEventListener('change', searchAndFilter);
    document.getElementById('tagFilter').addEventListener('change', searchAndFilter);
    document.getElementById('clearFilters').addEventListener('click', () => {
        document.getElementById('searchInput').value = '';
        document.getElementById('dateFilter').value = 'all';
        document.getElementById('tagFilter').value = 'all';
        searchAndFilter();
    });
    
    // –î–æ–¥–∞—Ç–∏ –ª–∏—Å—Ç
    document.getElementById('addLetterBtn').addEventListener('click', () => {
        editingLetterId = null;
        const t = translations[currentLanguage];
        document.getElementById('editModalTitle').textContent = t.addLetterModal;
        document.getElementById('letterForm').reset();
        document.getElementById('editModal').style.display = 'flex';
    });
    
    // –§–æ—Ä–º–∞ –ª–∏—Å—Ç–∞
    document.getElementById('letterForm').addEventListener('submit', saveLetter);
    
    // –ú–æ–¥–∞–ª—å–Ω—ñ –≤—ñ–∫–Ω–∞
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', hideDeleteModal);
    });
    
    document.querySelectorAll('.close-edit-modal').forEach(btn => {
        btn.addEventListener('click', hideEditModal);
    });
    
    document.getElementById('confirmDelete').addEventListener('click', confirmDelete);
    
    // –í–∏–±—ñ—Ä –º–æ–≤–∏
    document.querySelectorAll('.lang-option').forEach(option => {
        option.addEventListener('click', () => {
            const lang = option.dataset.lang;
            setLanguage(lang);
            document.querySelectorAll('.lang-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.lang === lang);
            });
            document.querySelector('.current-lang').textContent = getLanguageName(lang);
        });
    });
    
    // –í–∏–±—ñ—Ä —Ç–µ–º–∏
    document.querySelectorAll('.theme-option').forEach(option => {
        option.addEventListener('click', () => {
            const theme = option.dataset.theme;
            setTheme(theme);
        });
    });
    
    // –†–µ–∂–∏–º —á–∏—Ç–∞–Ω–Ω—è
    document.getElementById('readModeToggle').addEventListener('click', () => {
        isReadMode = !isReadMode;
        document.body.classList.toggle('read-mode-active', isReadMode);
        document.getElementById('readModeToggle').classList.toggle('active', isReadMode);
        localStorage.setItem('readMode', isReadMode);
    });
    
    // –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–∏—Ö –≤—ñ–∫–æ–Ω –ø–æ –∫–ª—ñ–∫—É –Ω–∞ —Ç–ª–æ
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
                if (modal.id === 'editModal') {
                    hideEditModal();
                } else if (modal.id === 'deleteModal') {
                    hideDeleteModal();
                }
            }
        });
    });
    
    // –û–±—Ä–æ–±–∫–∞ –∫–ª–∞–≤—ñ—à—ñ Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            hideDeleteModal();
            hideEditModal();
        }
    });
}

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
window.onload = initApp;

// –ì–ª–æ–±–∞–ª—å–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è HTML –∞—Ç—Ä–∏–±—É—Ç—ñ–≤ onclick
window.toggleExpand = toggleExpand;
window.editLetter = editLetter;
window.exportAsPDF = exportAsPDF;
window.exportAsTXT = exportAsTXT;
window.showDeleteModal = showDeleteModal;
